<!DOCTYPE html>
<html lang="en">
 <head>
    <meta charset="utf-8">
	<title>Echo Nest Remix</title>
	<link href='http://fonts.googleapis.com/css?family=Lato|Great+Vibes' rel='stylesheet' type='text/css'>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Echo Nest Remix:  The Internet Synthesizer">
    <meta name="author" content="Brian Whitman / Paul Lamere / Thor Kell">

   <link href="bootstrap.css" rel="stylesheet">
   <link href="font-awesome.css" rel="stylesheet">
   <link href="font-mfizz.css" rel="stylesheet">
    <link href="custom.css" rel="stylesheet">
    <link href="bootstrap-responsive.css" rel="stylesheet">
	

    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body>

<script src="jquery.min.js"></script>
<script type="text/javascript" src='remix.js'></script>
<script src="bootstrap.min.js"></script>
<script src="wavesurfer.js"></script>
<script src="drawer.js"></script>
<script src="dropzone.js"></script>
<script src="codemirror.js"></script>
<script src="raphael-min.js"></script>
<link rel="stylesheet" href="codemirror.css">
<script src="javascript.js"></script>
<script src="Chart.js"></script>
<script src="jquery.form.js"></script>

<script type="text/javascript">

// Remix with any track.
// To build your own back-end, take a look at remix-server:  
//switchbeat
var apiKey = 'AGZLSWIPISDC1OMHC';
var trackID;
var trackURL;
var driver;
var diffrence =0;

var paper;
var blocks = [];
var blocks1 = [];
var selectedTile;

var maxTimbre =0;
var minTimbre =0;
var maxTimbre1 =0;
var minTimbre1 =0;

var remixer;
var player;
var track;
var track1;
var track2;
var trid1;
var trid2;
var remixed;

var theCodeMirror;
var wavesurfer;
var remixedWaveSurfer;
var fs;
var myBarChartL;
var myBarChartP;
var myBarChartT;
var test =0;
var xhr;
var ctxProg;
var ProgChart;
var ctxProg1;
var ProgChart1;
var MashUpStarted =0;

var firstUpload =0;
var secondUpload=0;
var myPieChart;

var gradCounter = 1;

var timbreW =1;
var pitchW =10;
var loudStartW = 1;
var loudMaxW =1;
var durationW =100;
var confidenceW =1;

var midh =0;

var diffMean = 0;
var diffStd = 0;
var diffArray = [];

function createChart()
{

var ctxL = document.getElementById("myChartL").getContext("2d");
var ctxP = document.getElementById("myChartP").getContext("2d");
var ctxT = document.getElementById("myChartT").getContext("2d");
var ctxTrack = document.getElementById("myChartTrack").getContext("2d");

var dataL = {
    labels: ["Loudness"],
    datasets: [
        {
            label: "Music dataset",
            fillColor: "#5e2d79",
            strokeColor: "#5e2d79",
            highlightFill: "#8942b1",
            highlightStroke: "#8942b1",
            data: [0]
        }
        ]
};
var dataP = {
    labels: ["Pitch"],
    datasets: [
        {
            label: "Music dataset",
            fillColor: "#0080ff",
            strokeColor: "#0080ff",
            highlightFill: "#4da6ff",
            highlightStroke: "#4da6ff",
            data: [0]
        }
        ]
};
var dataT = {
    labels: ["Timbre"],
    datasets: [
        {
            label: "Music dataset",
            fillColor: "#006868",
            strokeColor: "#006868",
            highlightFill: "#009b9b",
            highlightStroke: "#009b9b",
            data: [0]
        }
        ]
};
var dataTrack = [
    {
        value: 1,
        color:"#4fffd3",
        highlight: "#69ffd9",
        label: "Track 1"
    },
    {
        value: 0,
        color: "#7a4eff",
        highlight: "#8d68ff",
        label: "Track 2"
    }
];
   


myBarChartL = new Chart(ctxL).Bar(dataL, {scaleBeginAtZero : false,  scaleShowGridLines : false,showScale: false, animationSteps: 30, showTooltips: false, animationEasing: "easeOutQuad", barValueSpacing : 0 });
myBarChartP = new Chart(ctxP).Bar(dataP, {scaleBeginAtZero : false,  scaleShowGridLines : false,showScale: false, animationSteps: 30, showTooltips: false,animationEasing: "easeOutQuad", barValueSpacing : 0});
myBarChartT = new Chart(ctxT).Bar(dataT, {scaleBeginAtZero : false,  scaleShowGridLines : false,showScale: false, animationSteps: 30, showTooltips: false,animationEasing: "easeOutQuad",barValueSpacing : 0 });
myPieChart = new Chart(ctxTrack).Pie(dataTrack,{animationEasing: "linear"});
	
}
function createBlocks(trackNum){

if(trackNum ==1)
{	
	var cblocks =[];
	var beats = track1.analysis.beats;

	for(var i =0; i< beats.length; i++)
	{
		
		cblocks.push(createBlock(i,beats[i],1));	

	}	

	return cblocks;
}	
else if(trackNum ==2)
{	
	var cblocks =[];
	var beats = track2.analysis.beats;

	for(var i =0; i< beats.length; i++)
	{
		
		cblocks.push(createBlock(i,beats[i],2));	

	}	

	return cblocks;
}	


}

function playClicked(){


	start();

}	

var blocktype =  {
	 normalColor:"#5f9",
	 
	  move: function(x,y) {
	
		 this.rect.attr({x:x, y:y});
		 this.x =x;
		 this.y =y;

		 

	 },	 
	 
	 play:function(){
		
		 player.play(0,this.beat);

	 },

	  position: function() {
        return {
            x: this.x,
            y: this.y
        }
    },

	 playStyle: function() {
        this.rect.attr("fill", "#FF9");
    },

	 normal: function() {
        this.rect.attr("fill", this.normalColor);
    },
	
	 select: function(){
		 this.rect.attr("fill", "#fffff");
		

		
	 },	 

	init:function() {
        var that = this;
	}	

}

function setnormvalues(trackNum){

if(trackNum ==1)
{	
	var segmentlist = track1.analysis.segments;
	var timbrelist;
	var timbreSum;
	var timbreMean;
	for(var i =0; i<segmentlist.length; i++)
	{	
		if(segmentlist[i])
		{	
		timbrelist = segmentlist[i].timbre;
		}
			
		timbreSum =0;
		for(var j=0; j<timbrelist.length; j++)
		{
			timbreSum = timbreSum +  timbrelist[j];

		}
		
		timbreMean = timbreSum/timbrelist.length;
			if(timbreMean<minTimbre)
			{
				minTimbre = timbreMean;	
			}
			if(timbreMean>maxTimbre)
			{
				
				maxTimbre = timbreMean;
			
			}	
	




	}	
}
else if(trackNum ==2)
{	
	var segmentlist = track2.analysis.segments;
	var timbrelist;
	var timbreSum;
	var timbreMean;
	for(var i =0; i<segmentlist.length; i++)
	{	
		if(segmentlist[i])
		{	
		timbrelist = segmentlist[i].timbre;
		}
			
		timbreSum =0;
		for(var j=0; j<timbrelist.length; j++)
		{
			timbreSum = timbreSum +  timbrelist[j];

		}
		
		timbreMean = timbreSum/timbrelist.length;
			if(timbreMean<minTimbre)
			{
				minTimbre1 = timbreMean;	
			}
			if(timbreMean>maxTimbre)
			{
				
				maxTimbre1 = timbreMean;
			
			}	
	




	}	
}





}

function getNormColor(segment){

	var sum = 0;
	var timbrelist = segment.timbre;

	for(var i =0; i<timbrelist.length;i++)
	{
		
		sum = sum + timbrelist[i];
		

	}	
	
	var mean = sum/(timbrelist.length);

	var norm = (mean - minTimbre) / (maxTimbre - minTimbre);

	//norm = norm * 16711680
	norm = norm * 16776960;
	return norm;	
}		
function convertToHex(norm)
{	
	var normAsInt = Math.round(norm);

	var normStr = Number(normAsInt).toString(16);

	return "#" + normStr;
	
}	
function getBlockColor(block,inputedbeat)
{
var color =0;
var meanLoudness =0;
var meanPitches = 0;
var segmentPitch;
var pitchList;
	var segmentlist = inputedbeat.overlappingSegments;

	for(var i=0; i<segmentlist.length; i++)
	{
		color = color + getNormColor(segmentlist[i]);
		meanLoudness = meanLoudness +segmentlist[i].loudness_max;
		
		pitchList = segmentlist[i].pitches;
		
		segmentPitch =0;

		for(var a=0; a<pitchList.length; a++)
		{
		
			segmentPitch = segmentPitch + pitchList[a];


		}	

		meanPitches = meanPitches + (segmentPitch/pitchList.length); 



		

	}	

	color = color/segmentlist.length;
	meanLoudness = meanLoudness/segmentlist.length;
	meanPitches = meanPitches/segmentlist.length;
	
	if(block)
	{	
	block.timbre =color;
	block.pitch = meanPitches;
	block.loudness = meanLoudness;
	}


	return convertToHex(color);



}	

function drawLine(block1,block2)
{

	
var block1num = 0;
var block2num = 0;
var line;

while(block1.Line[block1num])
{

	block1num = block1num +1;

}	
while(block2.Line[block2num])
{

	block2num = block2num +1;

}	

//var colorLine = "90-"+block1.normalColor+"-"+block2.normalColor;
//console.log(colorLine);
var gradId = "grad"+gradCounter;
gradCounter = gradCounter +1;

paper.defineLinearGradient(gradId, [{
    "id": "s1",
    "offset": "0",
    "style": "stop-color:"+block2.normalColor+";stop-opacity:1;"},
{
    "id": "s2",
    "offset": "1",
    "style": "stop-color:"+block1.normalColor+";stop-opacity:1;"}]);


var block1x = block1.x +(1/2)*block1.width;
var block1y = block1.y +(1/2)*block1.height;
var block2x = block2.x +(1/2)*block2.width;
var block2y = block2.y + (1/2)*block2.height;
var referencew = 0;
var referenceh = 0;
	if(block1x<=block2x)
	{
		referencew = Math.floor(Math.random()*(block2x - block1x)) + block1x;
	

	}
	else
	{
		referencew = Math.floor(Math.random()*(block1x - block2x)) + block2x;


	}
	if(block1y<=block2y)
	{


		referenceh = Math.floor(Math.random()*(block2y - block1y)) + block1y;



	}
	else
	{

		referenceh = Math.floor(Math.random()*(block1y - block2y)) + block2y;

	}	






line = paper.path(['M',block1x,block1y, 'Q',referencew ,referenceh, block2x,block2y]);

line.strokeLinearGradient (gradId, 2);

block1.Line[block1num] = line;
block1.otherIndex[block1num] = block2.number;
block1.otherLineIndex[block1num] = block2num;
block1.LineDefId [block1num] = gradId;

block2.Line[block2num] = line;
block2.otherIndex[block2num] = block1.number;
block2.otherLineIndex[block2num] = block1num;
block2.LineDefId[block2num] = gradId;





}
function createBlock(number,beat,trackNum)
{
	var labeled = false;
	var block = Object.create(blocktype);
	block.number = number;
	block.trackNum = trackNum;
	block.width = 11;
	block.height = 11;
	block.timbre =0;
	block.loudness =0;
	block.pitch = 0;
	block.Line = [];
	block.LineDefId = [];
	block.otherIndex = [];
	block.otherLineIndex = [];
	block.normalColor = getBlockColor(block,beat);

	block.rect = paper.rect(0,0,block.width, block.height);
	block.rect.attr("stroke", "#349");
	block.rect.block = block;
	block.normal();
	block.beat = beat;
	block.init();
	return block;
	


	
}
function PlayRemix(){



	

}
function sleep(milliseconds) {
  var start = new Date().getTime();
  for (var i = 0; i < 1e7; i++) {
    if ((new Date().getTime() - start) > milliseconds){
      break;
    }
  }
    
}
function Mashup(tracknum){

	 //remixed = new Array();
                  		//vair meter = parseInt(track.analysis.track.time_signature);
                  		
	//					for (var i=0; i < track.analysis.beats.length; i++) {
            					
	//								remixed.push(track.analysis.beats[i]);
	///								if(track.analysis.beats[i])
	//								{	
	//								console.log(track.analysis.beats[i].children);
	//								}										
									

									
                        		//player.play(0,track.analysis.segments[i]);
								//sleep(100);
                      			 
      //              	} 
                   
						if(tracknum == 1)
						{	
					 		waitForTrack2();

						}
						else if(tracknum == 2)
						{
							paper = Raphael("tiles",6, 4);
							setnormvalues(1);
							setnormvalues(2);
							createChart();
							blocks = createBlocks(1);
							blocks1 = createBlocks(2);
							Layout();
							//drawLine(blocks[blocks.length-1],blocks1[0]);
							calculateLinks();
							//console.log("tracks are ready");



						}	



                        $('#beginRemix').removeAttr('disabled');
                       // wavesurfer.loadBuffer(track.analysis.segments);
						//remixedWavesurfer.loadBuffer(remixed);








}


function waitForTrack2()
{
setTimeout(function () {
	if(!track2)
	{	
	waitForTrack2();

	}
	else if(track2.status != 'ok')
	{	
	waitForTrack2();
	}
	else
	{
		Mashup(2);
		return 0;
	}	
		}, 100);





}	

var margin = 15;
var top = 100;
var tilesPerGroup = 4;
var tspace = 3;
var tilesPerRow = 0;
var spaceInbetween = 200;

function Layout()
{

var num = blocks.length;
var num1 = blocks1.length;

if(num>0 && num1>0)
	{	
		var w = $(window).width();
		var h = $(window).height()-top;
		var rw = w - margin *2;
		var rh = h - margin *2;
		var tilesPerRow = Math.floor(rw/14);
		h = (Math.ceil(num/tilesPerRow) * 16) + 2*tspace + spaceInbetween + (Math.ceil(num1/tilesPerRow) * 16);
		paper.setSize(w,h);


		var xstart =0;
		var ystart =0;

		for(var i=0; i<blocks.length; i++)
		{
			var block = blocks[i];

			if(i % tilesPerRow == 0)
			{
				xstart = 0;
				ystart = ystart + block.height +tspace;


			}

			block.move(xstart,ystart);

			xstart = xstart + block.width + tspace;




		}	
		$(".MusicStatus").css("position","relative");
		var middleHeight = (h-(ystart + block.height + spaceInbetween/2)) * -1;
		middleHeight = middleHeight - 37.5;
		midH = middleHeight;
		middleHeight = middleHeight +"px";
		var middleWidth = (-1 * w/2)+185 + "px";
		midW = (-1*w/2)+185;
		
		$(".MusicStatus").css({top: middleHeight, right: middleWidth});

		ystart = ystart + block.height + spaceInbetween;
		xstart = 0;

		for(var i=0; i<blocks1.length; i++)
		{
			var block = blocks1[i];

			if(i % tilesPerRow == 0)
			{
				xstart = 0;
				ystart = ystart + block.height +tspace;


			}

			block.move(xstart,ystart);

			xstart = xstart + block.width + tspace;




		}	








	}	

}



function start()
{	

	play(1,-1,0,0);

}
function play(track,num,pTrack,pNum)
{
//console.log("starting");	

if(track == 1 && num>=blocks.length)
{
	play(2,0,1,blocks.length-1);

		
}
else if(track ==2 && num>=blocks1.length)
{
	play(1,0,2,blocks1.length-1);



}
else
{	
if(track == 1)
{

	if(num != -1)
	{	
		var delay = blocks[num].beat.duration;
		player.queue(blocks[num].beat);
	}
	else
	{
		var delay = blocks[0].beat.duration;
		player.queue(blocks[0].beat);
	}	


		
		setTimeout(function () {
	//	endTime = performance.now();
		//console.log(diffrence);
		//diffrence = (endTime -startTime) - 1000*blocks[num].beat.duration;
		if( num !=-1)
		{
			if(pTrack == 1)
			{	
			blocks[pNum].normal();	
			var pdefIdList = blocks[pNum].LineDefId;
			var plineList = blocks[pNum].Line;
			}
			else 
			{
			blocks1[pNum].normal();	
			var pdefIdList = blocks1[pNum].LineDefId;
			var plineList = blocks1[pNum].Line;

			


			}	
			var str;


			for(var i=0; i< plineList.length;i++)
			{
				
				plineList[i].strokeLinearGradient (pdefIdList[i], 2);



			}	

				
		}
		else
		{

			num = 0;

		}	
		
		blocks[num].select();

		var lineList = blocks[num].Line;
		var nextTrack = -1;
		var nextNum = -1;
		var randomNum =0;

		for(var i =0; i < lineList.length; i++)
		{

			lineList[i].attr("stroke", "#00000");
			randomNum = Math.random();
			if(randomNum < (sessionStorage.probability/100))
			{
				nextTrack = 2;
				nextNum = blocks[num].otherIndex[i];

			}	

		}
		myBarChartL.datasets[0].bars[0].value = 100 + blocks[num].loudness;
		myBarChartP.datasets[0].bars[0].value = blocks[num].pitch;
		myBarChartT.datasets[0].bars[0].value = blocks[num].timbre;
		myPieChart.segments[0].value = myPieChart.segments[0].value +1;
		myPieChart.update();
		myBarChartL.update();
		myBarChartP.update();
		myBarChartT.update();
		document.getElementById("BlockNum").textContent = blocks[num].number;
		document.getElementById("TrackNum").textContent = 1;

		if(nextTrack == -1 && nextNum == -1)
		{

			play(track,num+1,track,num);

		}
		else
		{
			play(nextTrack,nextNum,track,num);


		}	
		
		}, 1000*delay);
	
	
}

else if(track == 2)
{

	if(num != -1)
	{	
		var delay = blocks1[num].beat.duration;
		player.queue(blocks1[num].beat);
	}
	else
	{
		var delay = blocks1[0].beat.duration;
		player.queue(blocks1[0].beat);

	}
		
		setTimeout(function () {
	//	endTime = performance.now();
		//console.log(diffrence);
		//diffrence = (endTime -startTime) - 1000*blocks[num].beat.duration;
	
		if( num !=-1)
		{
			if(pTrack == 1)
			{	
			blocks[pNum].normal();	
			var pdefIdList = blocks[pNum].LineDefId;
			var plineList = blocks[pNum].Line;
			}
			else 
			{
			blocks1[pNum].normal();	
			var pdefIdList = blocks1[pNum].LineDefId;
			var plineList = blocks1[pNum].Line;

			


			}	
			var str;


			for(var i=0; i< plineList.length;i++)
			{
				
				plineList[i].strokeLinearGradient (pdefIdList[i], 2);

			
			}	

				
		}
    	else
		{

			num = 0;

		}	
		
		blocks1[num].select();

		var lineList = blocks1[num].Line;
		var nextTrack = -1;
		var nextNum = -1;
		var randomNum =0;

		for(var i =0; i < lineList.length; i++)
		{

			lineList[i].attr("stroke", "#00000");
			randomNum = Math.random();
			if(randomNum < (sessionStorage.probability/100))
			{
				nextTrack = 1;
				nextNum = blocks1[num].otherIndex[i];

			}	

		}
		myBarChartL.datasets[0].bars[0].value = 100 + blocks1[num].loudness;
		myBarChartP.datasets[0].bars[0].value = blocks1[num].pitch;
		myBarChartT.datasets[0].bars[0].value = blocks1[num].timbre;
		myPieChart.segments[1].value = myPieChart.segments[1].value +1;
		myPieChart.update();
		myBarChartL.update();
		myBarChartP.update();
		myBarChartT.update();
		document.getElementById("BlockNum").textContent = blocks1[num].number;
		document.getElementById("TrackNum").textContent = 2;

		if(nextTrack == -1 && nextNum == -1)
		{

			play(track,num+1,track,num);

		}
		else
		{
			play(nextTrack,nextNum,track,num);


		}	
		
		}, 1000*delay);
	
	
	}

}


}

function stop()
{
	blocks[blocks.length-1].normal();
	player.stop();

}	


// Get an estimation of analysis time
function fetchQinfo() {
    var url = 'http://remix.echonest.com/Uploader/qinfo?callback=?'
    $.getJSON(url, {}, function(data) {
        $("#info").text("Estimated analysis time: " + Math.floor(data.estimated_wait * 1.2) + " seconds.");
        $("#info1").text("Track 1 loaded successfully!  Estimated analysis time: " + Math.floor(data.estimated_wait * 1.2) + " seconds.");

    });
}

// Get the analysis, if it is ready
function analyzeAudio(audio, tag, callback) {
    var url = 'http://remix.echonest.com/Uploader/qanalyze?callback=?'
    $.getJSON(url, { url:audio, api_key:apiKey, tag:tag}, function(data) {
		console.log(data);
        if (data.status === 'done' || data.status === 'error') {
            callback(data);
        } else {
            $("#info").text(data.status + ' - ready in about ' + data.estimated_wait + ' secs. ');
			$("#info1").text(data.status + ' - ready in about ' + data.estimated_wait + ' secs. ');
            setTimeout(function() { analyzeAudio(audio, tag, callback); }, 8000);
        } 
    });
}

				  


//program starts here
function init() {

if(sessionStorage.trid1 !=0 && sessionStorage.trid1) 
{	
	
	if(!sessionStorage.trid2 || sessionStorage.trid2 ==0)
	{	
	$("#select-track").remove();
	$("#select-track1").removeClass("hidden");
	$("#infoO").hide();
	fetchSignature();
	//fetchQinfo();	
	}
}	
else
{	

	if(!sessionStorage.trid2 || sessionStorage.trid2 ==0)
	{	
	$("#inputParem").removeClass("hidden");
		
	}


	$("#infoO1").hide();


}	

	 var contextFunction = window.webkitAudioContext || window.AudioContext;
    if (contextFunction === undefined) {
        $("#info").text("Sorry, this app needs advanced web audio. Your browser doesn't"
            + " support it. Try the latest version of Chrome?");
    }
    // Read the URL query string to decide what to do
    var params = {};
    var q = document.URL.split('?')[1];
    if(q != undefined){
        q = q.split('&');
        for(var i = 0; i < q.length; i++){
            var pv = q[i].split('=');
            var p = pv[0];
            var v = pv[1];
            params[p] = v;
        }
    }

    if ('key' in params) {
        // We just uploaded a track.
        // We need to log the trackID and the URL, and then redirect.
        $("#select-track").hide();
		$("#select-track1").hide();
        $("#play-remix").hide();
        $("#info").text("Analyzing track 1 audio...");
	    $("#info1").text("Analyzing track 2 audio...");
        trackURL = 'http://' + params['bucket'] + '/' + urldecode(params['key']);

        analyzeAudio(trackURL, 'tag', function(data) {
            if (data.status === 'done') {
                var newUrl = location.protocol + "//" +  location.host + location.pathname;

				if(!sessionStorage.trid1)
				{
					sessionStorage.trid1 = data.trid;
					location.href = newUrl;
					


				}	
				else if(sessionStorage.trid1==0)
				{

					sessionStorage.trid1 = data.trid;
					location.href = newUrl;
					




				}	
				else
				{
						if(!sessionStorage.trid2)
						{
							sessionStorage.trid2 = data.trid;
							location.href = newUrl;
							


						}	
						else if(sessionStorage.trid2==0)
						{

							sessionStorage.trid2 = data.trid;
							location.href = newUrl;
							



						}	


				}	


            }
        });
    } 

   else  if (sessionStorage.trid1 && sessionStorage.trid2 && sessionStorage.trid1 !=0 && sessionStorage.trid2 !=0) {   
	   // We were passed a trackID directly in the url
        // We can remix the track we get back!
        //trackID = params['trid'];
	   	trid1 = sessionStorage.trid1;
		trid2 = sessionStorage.trid2;
		sessionStorage.trid1 =0;
		sessionStorage.trid2 = 0;
		$("#play-remix").show();
        $("#select-track").hide();
		$("#select-track1").hide();
		$("#infoO").show();
		$("#infoO1").show();


	function getTrack1Info()
	{	
        var urlXHR = getProfile(trid1, function(data) {
			
            trackURL = data.url;
		    if (data.status == true) {
                console.log("Track 1 ready to remix");
                                
                // Only use the filesystem if we have access to it.
                //if (window.File && window.FileReader && window.FileList && window.Blob && window.webkitRequestFileSystem) {
                //    window.requestFileSystem  = window.requestFileSystem || window.webkitRequestFileSystem;
                //    window.requestFileSystem(window.TEMPORARY, 1024*1024, function(filesystem) {
               //         fs = filesystem;
               //     }, fileErrorHandler);
               // }

             if(!remixer) 
			 {	var context = new contextFunction();
                remixer = createJRemixer(context, $, apiKey);
                player = remixer.getPlayer();

			 }                     
             
                $("#info").text("Loading track 1 analysis data...");

				
				ctxProg = document.getElementById("myChartProg").getContext("2d");
				var Progdata = [
    			{
        			value: 0,
        			color:"#4fffd3",
        			highlight:"#69ffd9",
        			label: "loaded"
    			},
    			{
        			value: 100,
        			color:"#cdfff3",
        			highlight:"#e7fff9",
        			label: "Not loaded"
    			}
    			]
 ProgChart = new Chart(ctxProg).Doughnut(Progdata,{ animation: false, animationEasing: "linear",showTooltips: false});



				
				remixer.remixTrackById(trid1, trackURL, function(t, percent) {
                    track1 = t;
									
					ProgChart.options.animation = true;
					ProgChart.options.animationSteps = 30;
					ProgChart.segments[1].value = 100 - percent;
					ProgChart.segments[0].value = percent;
					ProgChart.update();

                    $("#info").text(percent + "% of the track 1 loaded...");
                    if (percent == 100) {
                        $("#info").text(percent + "% of the track 1 loaded, preparing...");
                    }

                    if (track1.status == 'ok') {
                        $("#info").text("Track 1 ready to remix!");
						
					
						Mashup(1);

                        $('.btn-original').removeAttr('disabled');
                    }
                    else if (track1.status == 'error' ) {
                       // $("#info").text("Error getting the track URL - please try again, or re-upload the file.");
					 }

                });
            }
            else {
               /* console.log("Track id error.");
                $("#play-remix").hide();
                $("#select-track").show();
                $("#info").text("Error getting the track URL - please try again, or re-upload the file.");
                $("#redirect-url").attr('value', document.URL);

                $("#file").change( 
                    function() {
                        //fetchQinfo();
                        var filename = $("#file").val();
                        if (endsWith(filename.toLowerCase(), ".mp3")) {
                            $("#f-filename").attr('value', fixFileName(filename));
                            $("#upload").removeAttr('disabled');
                        } else {
                            alert('Sorry, this app only supports MP3s');
                            $("#upload").attr('disabled', 'disabled');
                        }
                    }
                );
                fetchSignature();
            }*/
				console.log("retrying");
				 setTimeout(function() { getTrack1Info() }, 500);

		} 

		});

		//##########################end of first file upload#####################
		}
		getTrack1Info()

		  var urlXHR1 = getProfile(trid2, function(data) {
            trackURL = data.url;
		  if (data.status == true) {
                console.log("Track 2 ready to remix");
                //var context = new contextFunction();
                
                // Only use the filesystem if we have access to it.
               // if (window.File && window.FileReader && window.FileList && window.Blob && window.webkitRequestFileSystem) {
                //    window.requestFileSystem  = window.requestFileSystem || window.webkitRequestFileSystem;
                //    window.requestFileSystem(window.TEMPORARY, 1024*1024, function(filesystem) {
                //        fs = filesystem;
                //    }, fileErrorHandler);
               // }

              
                //remixer = createJRemixer(context, $, apiKey);
                //player = remixer.getPlayer();
				//var context = new contextFunction();
                
                // Only use the filesystem if we have access to it.
                //if (window.File && window.FileReader && window.FileList && window.Blob && window.webkitRequestFileSystem) {
                //    window.requestFileSystem  = window.requestFileSystem || window.webkitRequestFileSystem;
                //    window.requestFileSystem(window.TEMPORARY, 1024*1024, function(filesystem) {
               //         fs = filesystem;
               //     }, fileErrorHandler);
               // }

             if(!remixer) 
		     {	var context = new contextFunction();
                remixer = createJRemixer(context, $, apiKey);
                player = remixer.getPlayer();

			 }                     

                                  
             
                $("#info1").text("Loading track 2 analysis data...");

				ctxProg1 = document.getElementById("myChartProg1").getContext("2d");
				var Progdata1 = [
    			{
        			value: 0,
        			color:"#7a4eff",
        			highlight:"#8d68ff",
        			label: "loaded"
    			},
    			{
        			value: 100,
        			color:"#c6b6ff",
        			highlight:"#dad0ff",
        			label: "Not loaded"
    			}
    			]
 ProgChart1 = new Chart(ctxProg1).Doughnut(Progdata1,{ animation: false, animationEasing: "linear",showTooltips: false});



			
                remixer.remixTrackById(trid2, trackURL, function(t, percent) {

					track2 = t;
					
					ProgChart1.options.animation = true;
					ProgChart1.options.animationSteps = 30;
					ProgChart1.segments[1].value = 100 - percent;
					ProgChart1.segments[0].value = percent;
					ProgChart1.update();


                    
					$("#info1").text(percent + "% of the track 2 loaded...");
                    if (percent == 100) {
                        $("#info1").text(percent + "% of the track 2 loaded, preparing...");
                    }

                    if (track2.status == 'ok') {
                        $("#info1").text("Track 2 ready to remix!");
						
						//Mashup(2);

                        //$('.btn-original').removeAttr('disabled');
                    }
                    else if (track2.status == 'error' ) {
                        //$("#info1").text("Error getting the track URL - please try again, or re-upload the file.");
					}

                });
            }
            else {
                console.log("Track id error.");
                $("#play-remix").hide();
                $("#select-track").show();
                $("#info").text("Error getting the track URL - please try again, or re-upload the file.");
                $("#redirect-url").attr('value', document.URL);

                $("#file").change( 
                    function() {
                        //fetchQinfo();
                        var filename = $("#file").val();
                        if (endsWith(filename.toLowerCase(), ".mp3")) {
                            $("#f-filename").attr('value', fixFileName(filename));
                            $("#upload").removeAttr('disabled');
                        } else {
                            alert('Sorry, this app only supports MP3s');
                            $("#upload").attr('disabled', 'disabled');
                        }
                    }
                );
                fetchSignature();
            }
        });





    } else {
        // We're waiting for the user to pick a track and upload it
	    $("#play-remix").hide();
        $("#redirect-url").attr('value', document.URL);

        $("#file").change( 
            function() {
				console.log($("#file"));
                var filename = $("#file").val();
                if (endsWith(filename.toLowerCase(), ".mp3")) {
                    $("#f-filename").attr('value', fixFileName(filename));
                    $("#upload").removeAttr('disabled');
                } else {
                    alert('Sorry, this app only supports MP3s');
                    $("#upload").attr('disabled', 'disabled');
                }
            }
        );
        fetchSignature();
        fetchQinfo();
		
    }
}

//"use strict";
function submitForm(oFormElement)
{

	var cutoff = document.getElementById("rangeInput").value;
	var probability = document.getElementById("rangeInputJump").value;

	sessionStorage.cutoff = cutoff;
	sessionStorage.probability = probability;

	console.log(cutoff);
	console.log(probability);

	 $("#inputParem").hide();
  	 $("#select-track").hide();
 	 console.log(oFormElement);	

    //check whether browser fully supports all File API
    if (window.File && window.FileReader && window.FileList && window.Blob)
    {
        //get the file size and file type from file input field
        var fsize = $('#file')[0].files[0].size;
		fsize = (fsize/1000000).toFixed(2);
		$('#info').text("Uploading Track 1 -  "+fsize+" MB");
        
		console.log(fsize);
    }

}
function submitForm1(oFormElement)
{
   $("#select-track1").hide();

	 console.log(oFormElement);	
    //check whether browser fully supports all File API
    if (window.File && window.FileReader && window.FileList && window.Blob)
    {
        //get the file size and file type from file input field
        var fsize = $('#file')[0].files[0].size;
		fsize = (fsize/1000000).toFixed(2);
		$('#info1').text("Uploading Track 2 -  "+fsize+" MB");
        
		console.log(fsize);
    }

}


function calculateLinks()
{	

console.log("started");

var blockDiffList = [[]];
var blockNormList = [];
var result;
var listNum =0;


	for(var i =0; i<blocks.length; i++)
	{

		for(var j = 0; j<blocks1.length; j++)
		{
			
			
				
			result = beatDistance(track1.analysis.beats[i],track2.analysis.beats[j]);
			blockNormList[listNum] = result;
			if(!blockDiffList[i])
			{
				blockDiffList[i] = [];	
			}	
			blockDiffList[i][j] = result;
			listNum = listNum +1;
			
			

		}	
		
		

	}	

	console.log("endloop");
	diffArray = blockNormList;
	calculateMeanAndStd();
	console.log("afterMean");
	var percentage =0;

	var firstTrackIndex = [];
	var secondTrackIndex = [];

	var TrackIndexNum =0;

	for(var i =0; i<blocks.length; i++)
	{

		for(var j = 0; j<blocks1.length; j++)
		{
			
			percentage = compute(blockDiffList[i][j],diffMean,diffStd);
		if(percentage<(sessionStorage.cutoff/100))
			{
					
				//drawLine(blocks[i],blocks1[j]);
				firstTrackIndex[TrackIndexNum] = blocks[i];
				secondTrackIndex[TrackIndexNum] = blocks1[j];
				TrackIndexNum = TrackIndexNum +1;

			}	
			//console.log(percentage);
			

		}	


	}
	

	$("#infoO1").hide();
	$("#info").text("Creating connections between tracks");

	var contextConnectionProg = document.getElementById("myChartProg").getContext('2d');
	contextConnectionProg.clearRect(0, 0,  document.getElementById("myChartProg").width,  document.getElementById("myChartProg").height);
	
			var ConnectionData1 = [
    			{
        			value: 0,
        			color:"#e89600",
        			highlight:"#ffa602",
        			label: "loaded"
    			},
    			{
        			value: TrackIndexNum,
        			color:"#ffd381",
        			highlight:"#ffe5b4",
        			label: "Not loaded"
    			}
    			]
 
	var myConnectionChart = new Chart(contextConnectionProg).Doughnut(ConnectionData1,{ animation: false, animationEasing: "linear",showTooltips: false});


		for(var i =0; i<TrackIndexNum; i++)
		{
			
					myConnectionChart.options.animation = true;
					myConnectionChart.options.animationSteps = 30;
					myConnectionChart.segments[1].value = myConnectionChart.segments[1].value -1;
					myConnectionChart.segments[0].value = myConnectionChart.segments[0].value +1;
					myConnectionChart.update();
					drawLine(firstTrackIndex[i],secondTrackIndex[i]);






		}	





}

function beatDistance(beat1,beat2)
{	
var segmentBeat1 = []; 
	segmentBeat1 = beat1.overlappingSegments;
var segmentBeat2 = [];
	segmentBeat2 = beat2.overlappingSegments;

var beatDiff = 0;
var segmentNum = 0;

while( segmentBeat1[segmentNum] && segmentBeat2[segmentNum])
{

	beatDiff = beatDiff + segmentDistance(segmentBeat1[segmentNum],segmentBeat2[segmentNum]);
	segmentNum = segmentNum +1;


}	


return beatDiff/segmentNum;



}
function segmentDistance(segment1,segment2)
{

	var timbreDiff = getDistance(segment1.timbre,segment2.timbre);
	var pitchDiff = getDistance(segment1.pitches, segment2.pitches);
	var loudStartDiff = Math.abs(segment1.loudness_start - segment2.loudness_start);
	var loudMaxDiff = Math.abs(segment1.loudness_max -segment2.loudness_max);
	var durationDiff = Math.abs(segment1.duration - segment2.duration);
	var confidenceDiff = Math.abs(segment1.confidence - segment2.confidence);
	var distance = (timbreDiff * timbreW) + (pitchDiff * pitchW) + (loudStartDiff * loudStartW) + (loudMaxDiff * loudMaxW) + (durationDiff *durationW) + (confidenceDiff * confidenceW);
	return distance;



}
function getDistance(element1, element2)
{
	var TotalSum =0;
	var diff =0;

	for(var i =0; i<element1.length; i++)
	{

		if(element1[i] && element2[i])
		{

			diff = element1[i] -element2[i];
			TotalSum = TotalSum + diff*diff;

		}	


	}	

	return Math.sqrt(TotalSum);





}	





//http://www.math.ucla.edu/~tom/distributions/normal.html
function normalcdf(X){   
var T=1/(1+.2316419*Math.abs(X));
var D=.3989423*Math.exp(-X*X/2);
var Prob=D*T*(.3193815+T*(-.3565638+T*(1.781478+T*(-1.821256+T*1.330274))));
if (X>0) 
{	
	Prob=1-Prob
}	
return Prob
}
function compute(num,mean,stdev) {  
	Z= num;  
	M= mean;  
	SD= stdev; 
	with (Math) {		
		if (SD<0) {	
			alert("The standard deviation must be nonnegative.")
		} else if (SD==0) {
			if (Z<M){
				Prob=0	
			} else {	
				Prob=1
			}	
		} else {	
			Prob=normalcdf((Z-M)/SD);
			Prob=round(100000*Prob)/100000;
		}	
	}   
	return Prob;
}

function calculateMeanAndStd()
{

var mean = 0;
var std = 0;
var sum = 0;
var meanSum =0;
for(var i =0; i<diffArray.length; i++)
	{
		sum = sum + diffArray[i];	
			


	}

 mean = sum / diffArray.length;
 diffMean = mean;

for(var j =0; j<diffArray.length; j++)
	{
		meanSum = meanSum +  ( mean - diffArray[j])*(mean-diffArray[j]);
					


	}	

	var variance = meanSum/diffArray.length;
	std = Math.sqrt(variance);
	diffStd = std;




}	
// $(document).ready(function() { 
            // bind 'myForm' and provide a simple callback function 
          //  $('#myForm').ajaxForm(function() { 
           //     alert("Thank you for your comment!"); 
            //});
//		var options = { 
 //   uploadProgress: function(event, position, total, percentComplete) 
  //  {
       // $("#bar").width(percentComplete+'%');
        //$("#percent").html(percentComplete+'%');
 
 //   }
    
   
//}; 
//$("#myForm").ajaxForm(options);
//}); 

/*global Raphael:true*/
//http://stackoverflow.com/questions/4771517/raphael-js-path-line-with-gradient
(function() {
    if (Raphael.vml) {
        Raphael.el.strokeLinearGradient = function() {
            // not supporting VML yet
            return this; // maintain chainability
        };
    } else {
        var setAttr = function(el, attr) {
            var key;
            if (attr) {
                for (key in attr) {
                    if (attr.hasOwnProperty(key)) {
                        el.setAttribute(key, attr[key]);
                    }
                }
            } else {
                return document.createElementNS("http://www.w3.org/2000/svg", el);
            }

            return null;
        };

        var defLinearGrad = function(defId, stops) {
            var def = setAttr("linearGradient");
            var i, l;
            def.id = defId;

            for (i = 0, l = stops.length; i < l; i += 1) {
                var stopEle = setAttr("stop");
                var stop = stops[i];
                setAttr(stopEle, stop);

                def.appendChild(stopEle);
            }

            return def;
        };

        Raphael.el.strokeLinearGradient = function(defId, width, stops) {

            if (stops) {
                this.paper.defs.appendChild(defLinearGrad(defId, stops));
            }

            setAttr(this.node, {
                "stroke": "url(#" + defId + ")",
                "stroke-width": width
            });

            return this; // maintain chainability
        };

        Raphael.st.strokeLinearGradient = function(defId, width, stops) {
            return this.forEach(function(el) {
                el.strokeLinearGradient(defId, width, stops);
            });
        };

        Raphael.fn.defineLinearGradient = function(defId, stops) {
			
			console.log(stops);

            this.defs.appendChild(defLinearGrad(defId, stops));
        };
    }
}());






window.onload = init;
</script>

       
    <div class="container">
		<span id="programTitle">SwitchBeat&nbsp;&nbsp;<span class="musicAndCode">{</span><i class="fa  fs-fw fa-music"></i><span class="musicAndCode">}</span></span>
		<span id="programDescrip">&nbsp;&nbsp;&nbsp;&nbsp;<em>Mashup two of your favorite songs</em></span><br><br>
       	<div id="inputParem" class="hidden">
			<h3><i class="fa fa-toggle-on fa-fw optionicon"></i>&nbsp;&nbsp;Options</h3>
			<hr>
		<span id="sliderThreshold">Select the percentage cut off for music connections:
			<form oninput="amount.value=rangeInput.value">
    		<input type="range" id="rangeInput" name="rangeInput" min=".01" max="10" value="5" step=".01">                                                       
        	&nbsp;<output name="amount" for="rangeInput">5</output>%
        </form>
		</span>
		<span id="sliderJump">Select the probability for a connection jump:
			<form oninput="JumpAmount.value=rangeInputJump.value">
    		<input type="range" id="rangeInputJump" name="rangeInputJump" min=".1" max="100" value="50" step=".1">                                                       
        	&nbsp;<output name="JumpAmount" for="rangeInputJump">50</output>%
			
			</form>
		</span>
		<span id="sliderConnection">Select the probability for a connection jump:
			<form oninput="ConnectionAmount.value=rangeInputConnection.value">
    		<input type="range" id="rangeInputConnection" name="rangeInputConnection" min=".1" max="100" value="50" step=".1">                                                       
        	&nbsp;<output name="ConnectionAmount" for="rangeInputConnection">50</output>%
			
			</form>
		</span>
			<span id="switchText" style="
  			  /* height: 20px; */
   			 line-height: 2;
			">Infinite Mode - end of one track will jump to the start of another</span>
			&nbsp;<div class="onoffswitch">
			<input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="myonoffswitch" checked>
    		<label class="onoffswitch-label" for="myonoffswitch">
        	<span class="onoffswitch-inner"></span>
        	<span class="onoffswitch-switch"></span>
    		</label>
			</div>
        </form>
		</span>
		</div>

		<br>

		<div id = "uploadParem">
			<h3><i class="fa fa-upload fa-fw"></i>&nbsp;&nbsp;Upload</h3>
			<hr>
		<span id="infoO"><span id="info"></span>&nbsp;&nbsp;<canvas id="myChartProg" width="25" height="25"></canvas><br></span>
		<span id="infoO1"><span id="info1"></span>&nbsp;&nbsp;<canvas id="myChartProg1" width="25" height="25"></canvas><br></span>
		

        <section>
        <div id='select-track'>
            <form action="https://s3.amazonaws.com/static.echonest.com" method="post" enctype="multipart/form-data" onSubmit="submitForm(this);">
              <input id='f-filename' type="hidden" name="key" value="remix_audio/${filename}">
              <input id='f-key' type="hidden" name="AWSAccessKeyId" value="YOUR_AWS_ACCESS_KEY"> 
              <input type="hidden" name="acl" value="public-read"> 
              <input id='redirect-url' type="hidden" name="success_action_redirect"
                  value="YOUR_URL">
              <input id='f-policy' type="hidden" name="policy" value="YOUR_POLICY_DOCUMENT_BASE64_ENCODED">
              <input id='f-signature' type="hidden" name="signature" value="YOUR_CALCULATED_SIGNATURE">
              <input type="hidden" name="Content-Type" value="audio/mpeg">
			  Select the first <b>mp3</b> to upload : <input  id="file" name="file" type="file"> 
              <br>
              <input class="btn btn-primary btn-default" id='upload' type="submit" value="Upload MP3"> 
            </form> 
        </div>
		<div id='select-track1' class='hidden'>
            <form action="https://s3.amazonaws.com/static.echonest.com" method="post" enctype="multipart/form-data" onSubmit="submitForm1(this);">
              <input id='f-filename' type="hidden" name="key" value="remix_audio/${filename}">
              <input id='f-key' type="hidden" name="AWSAccessKeyId" value="YOUR_AWS_ACCESS_KEY"> 
              <input type="hidden" name="acl" value="public-read"> 
              <input id='redirect-url' type="hidden" name="success_action_redirect"
                  value="YOUR_URL">
              <input id='f-policy' type="hidden" name="policy" value="YOUR_POLICY_DOCUMENT_BASE64_ENCODED">
              <input id='f-signature' type="hidden" name="signature" value="YOUR_CALCULATED_SIGNATURE">
              <input type="hidden" name="Content-Type" value="audio/mpeg">
			  Select the second <b>mp3</b> to upload : <input  id="file" name="file" type="file"> 
              <br>
              <input class="btn btn-primary btn-default" id='upload' type="submit" value="Upload MP3"> 
            </form> 
        </div>
		
		<div id="status"></div>

        </section>
		</div>	
        <section id='play-remix'>
            <div id="userCode">
                <p><textarea id="userInput"></textarea></p>
                <button class='btn btn-original' id='beginRemix' onClick="beginRemix()">Remix!</button>
            </div>
            <div id='waveform'>
            <h2>Original Track</h2>
            <canvas id='waveCanvas' width='1024px' height='100px'></canvas>
            <br />
            <button class='btn btn-inverse btn-original' onClick="player.play(0, track.analysis.beats);">Play Original</button>
            <button class='btn btn-original' onClick="player.stop()">Stop Original</button>
            </div>

            <div id='newWaveform'>
            <h2>Remixed Track</h2>
            <canvas id='RemixedWaveCanvas' width='1024px' height='100px'></canvas>
            <br />
            <button class='btn btn-inverse btn-remixed' onClick="playClicked();">Play Remix</button>
            <button class='btn btn-remixed' onClick="stop();">Stop Remix</button>
            <span id='downloadButton'></a>
            </div>

			<div id='tiles'></div>
			<div class="MusicStatus">
			&nbsp;&nbsp;	
			<canvas id="myChartL" width="50" height="50"></canvas>
			<canvas id="myChartP" width="50" height="50"></canvas>
			<canvas id="myChartT" width="50" height="50"></canvas>
			&nbsp;
			 Block: <span id='BlockNum'> 1 </span>
			&nbsp;
			Track: <span id='TrackNum'> 1 </span>
			&nbsp;
			<canvas id="myChartTrack1" width="50" height="50"></canvas>
			<br>
			<span id="chartLabels" style="
    font-size: 12px;
">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Loud&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Pitch&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Timbre&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Track ratio</span>
			</div>
        </section>
   
  </div> <!-- /container -->
<footer>
	<br>
	<br>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Brought to you by:<br>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://the.echonest.com/"> <img src="EchoNest.png" alt="EchoNest"></a> 
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://pages.github.com/"><img src="github.png" alt="Github Pages" height="29"></a> 	
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://jekyllrb.com/"><img src="jekyll.png" alt="Jekyll"></a> 	
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="icon-javascript" style="color:#ffbf00; font-size: 72px; position: relative; top: -30px;"></i><br><br>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>SwitchBeat</b> is coded by <b>Nikhil Kumar </b> inspired by <a href="http://labs.echonest.com/Uploader/index.html">The Infinite Jukebox</a>, check out more at <a href="http://kumarcode.com/">Kumarcode.com</a>
</footer>
</body>
</html>
